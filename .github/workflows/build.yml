name: HTOS APC Service AOSP CI

on: [push, workflow_dispatch]

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate AOSP-Style Keystore
        run: |
          # 模拟 AOSP 官方签发者信息：
          # CN: HTOS Framework, OU: Core, O: Android Open Source Project
          keytool -genkey -v -keystore htos_aosp.jks \
          -alias aosp_key -keyalg RSA -keysize 2048 -validity 36500 \
          -storepass aosp_htos \
          -keypass aosp_htos \
          -dname "CN=HTOS Framework, OU=Core, O=Android Open Source Project, L=Mountain View, ST=California, C=US"

      # --- 关键补齐步骤 ---
      - name: Setup Gradle Wrapper
        run: |
          # 如果仓库根目录没有 gradlew，则自动初始化
          if [ ! -f gradlew ]; then
            gradle wrapper --gradle-version 8.2
          fi
          chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Sign APK with apksigner
        run: |
          UNSIGNED_APK=$(find app/build/outputs/apk/release/ -name "*.apk")
          # 签名输出，文件名伪装成 AOSP 补丁包
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign --ks htos_aosp.jks \
          --ks-key-alias aosp_key \
          --ks-pass pass:aosp_htos \
          --out HTOS_AOSP_Patch.apk $UNSIGNED_APK

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: HTOS-AOSP-Official-Build
          path: HTOS_AOSP_Patch.apk
