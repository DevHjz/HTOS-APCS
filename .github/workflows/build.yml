name: HTOS APC Service SYSTEM CI

on: [push, workflow_dispatch]

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Fake SYSTEM Keystore
        run: |
          # 修改后的 DNAME：
          # CN (Common Name): HTOS
          # OU (Organizational Unit): System Core
          # O (Organization): SYSTEM
          # L (Locality): Android
          # ST (State): Internal
          # C (Country): US
          keytool -genkey -v -keystore htos_system.jks \
          -alias system_key -keyalg RSA -keysize 2048 -validity 36500 \
          -storepass android_system \
          -keypass android_system \
          -dname "CN=HTOS, OU=System Core, O=SYSTEM, L=Android, ST=Internal, C=US"

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Sign APK with apksigner
        run: |
          # 定位构建生成的未签名 APK
          UNSIGNED_APK=$(find app/build/outputs/apk/release/ -name "*.apk")
          # 签名并输出最终文件
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign --ks htos_system.jks \
          --ks-key-alias system_key \
          --ks-pass pass:android_system \
          --out HTOS_APCS_System_Signed.apk $UNSIGNED_APK

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: HTOS-APCS-System-Build
          path: HTOS_APCS_System_Signed.apk
